<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç†ã®é­”æ³•ä½¿ã„ - ãƒãƒ™ãƒ«ã‚²ãƒ¼ãƒ </title>
    <link rel="manifest" href="manifest.json">
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
    <div id="app"></div>

    <script>
        // ============================================
        // ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
        // ============================================

        console.log('Script loaded. Game starting...');

        let episodesData = null;
        let scenarioData = null;

        // ============================================
        // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        // ============================================

        let gameState = {
            screen: 'TITLE', // TITLE | CHAPTER_GALLERY | MAIN | RESULT
            currentStoryID: 1100,
            currentSceneTags: [],
            flags: {},
            isTextComplete: false,
            displayText: '',
            fullText: '',
            selectedChapter: 'ep1-ch1',
            isTextComplete: false,
            displayText: '',
            fullText: '',
            selectedChapter: 'ep1-ch1',
            isPanelOpen: true,
            isMenuOpen: false
        };

        let typewriterInterval = null;

        // ============================================
        // åˆæœŸåŒ–
        // ============================================

        async function initGame() {
            try {
                const [episodesRes, scenarioRes] = await Promise.all([
                    fetch('./data/episodes.json'),
                    fetch('./data/scenario.json')
                ]);

                if (!episodesRes.ok || !scenarioRes.ok) {
                    throw new Error('Failed to load game data');
                }

                episodesData = await episodesRes.json();
                scenarioData = await scenarioRes.json();

                render();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('app').innerHTML = `
                    <div style="color:white; text-align:center; padding:2rem;">
                        <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
                        <p>ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é–‹ã„ã¦ã„ã‚‹å ´åˆã¯ã€<br>ç°¡æ˜“Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</p>
                        <p>(${error.message})</p>
                    </div>
                `;
            }
        }

        // ============================================
        // ç”»é¢æç”»
        // ============================================

        function render() {
            // ãƒ‡ãƒ¼ã‚¿æœªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ä½•ã‚‚ã—ãªã„ã‹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            if (!episodesData || !scenarioData) return;

            const app = document.getElementById('app');
            app.innerHTML = '';

            switch (gameState.screen) {
                case 'TITLE':
                    renderTitleScreen(app);
                    break;
                case 'CHAPTER_GALLERY':
                    renderChapterGallery(app);
                    break;
                case 'MAIN':
                    renderMainGame(app);
                    break;
                case 'RESULT':
                    renderResultScreen(app);
                    break;
            }
        }

        // ============================================
        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢
        // ============================================

        function renderTitleScreen(app) {
            app.innerHTML = `
        <div class="title-screen">
          <div class="title-content">
            <h1 class="game-title">ç†ã®é­”æ³•ä½¿ã„</h1>
            <button class="start-button" onclick="goToChapterGallery()">å§‹ã‚ã‚‹</button>
          </div>
        </div>
      `;
        }

        // ============================================
        // ChapterGalleryç”»é¢
        // ============================================

        function renderChapterGallery(app) {
            const selectedChapterData = findChapterById(gameState.selectedChapter);
            const chapterTitle = selectedChapterData ? selectedChapterData.chapter.title : '';
            const episodeTitle = selectedChapterData ? selectedChapterData.episode.title : '';

            app.innerHTML = `
        <div class="chapter-gallery-screen">
          ${renderSidePanel()}
          <div class="main-content-area">
            <div class="chapter-title-section">
              <div class="chapter-subtitle">${episodeTitle}</div>
              <h2 class="chapter-main-title">${chapterTitle}</h2>
            </div>
            ${renderEventsList()}
          </div>
        </div>
      `;
        }

        function renderSidePanel() {
            const panelClass = gameState.isPanelOpen ? '' : 'closed';
            const toggleIcon = gameState.isPanelOpen ? 'â—€' : 'â–¶';

            let episodesHTML = '';
            episodesData.episodes.forEach(episode => {
                let chaptersHTML = '';
                episode.chapters.forEach(chapter => {
                    const activeClass = chapter.id === gameState.selectedChapter ? 'active' : '';
                    chaptersHTML += `
            <div class="chapter-item ${activeClass}" onclick="selectChapter('${chapter.id}')">
              ${chapter.title}
            </div>
          `;
                });

                episodesHTML += `
          <div class="episode-item">
            <div class="episode-header">${episode.title}</div>
            <div class="chapter-list">
              ${chaptersHTML}
            </div>
          </div>
        `;
            });

            return `
        <div class="side-panel ${panelClass}">
          <button class="toggle-panel-btn" onclick="togglePanel()">${toggleIcon}</button>
          <div class="side-panel-header">
            <div class="side-panel-title">ç›®æ¬¡</div>
          </div>
          <div class="stepper-container">
            ${episodesHTML}
          </div>
        </div>
      `;
        }

        function renderEventsList() {
            const selectedChapterData = findChapterById(gameState.selectedChapter);
            if (!selectedChapterData) return '<p>ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';

            const events = selectedChapterData.chapter.events;
            if (events.length === 0) {
                return '<p style="text-align: center; color: #8b7355; font-size: 1.2rem; margin-top: 3rem;">Coming Soon...</p>';
            }

            let eventsHTML = '';
            events.forEach(event => {
                eventsHTML += `
          <div class="event-card" onclick="startEvent(${event.startStoryID})">
            <h3 class="event-title">${event.title}</h3>
            <p class="event-description">${event.description}</p>
            <button class="event-read-btn" onclick="startEvent(${event.startStoryID}); event.stopPropagation();">
              èª­ã‚€
            </button>
          </div>
        `;
            });

            return `<div class="events-grid">${eventsHTML}</div>`;
        }

        // ============================================
        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢
        // ============================================

        function renderMainGame(app) {
            console.log('renderMainGame: Current Story ID:', gameState.currentStoryID);
            const node = scenarioData.scenario.find(n => n.storyID === gameState.currentStoryID);
            console.log('renderMainGame: Found node:', node);

            if (!node) {
                console.error('renderMainGame: Node not found for ID:', gameState.currentStoryID);
                return;
            }

            if (node.type === 'SCENE_START') {
                console.log('renderMainGame: SCENE_START detected');
                gameState.currentSceneTags = node.sceneTags || [];
                const currentIndex = scenarioData.scenario.findIndex(n => n.storyID === gameState.currentStoryID);
                const nextNode = scenarioData.scenario[currentIndex + 1];
                console.log('renderMainGame: Next node:', nextNode);

                setTimeout(() => {
                    if (nextNode) {
                        console.log('renderMainGame: Transitioning to next node:', nextNode.storyID);
                        gameState.currentStoryID = nextNode.storyID;
                        render();
                    } else {
                        console.warn('renderMainGame: No next node found after SCENE_START');
                    }
                }, 500);
                return;
            }

            const bgClass = gameState.currentSceneTags[0]?.includes('magic_tower') ? 'bg-magic-tower' :
                gameState.currentSceneTags[0]?.includes('magic_circle') ? 'bg-magic-circle' :
                    'bg-black';

            const charaTags = node.tags?.filter(t => t.startsWith('chara_')) || [];
            const charaHTML = charaTags.map(tag => {
                const emoji = tag.includes('mage') ? 'ğŸ§™' : tag.includes('familiar') ? 'ğŸ¦Š' : 'ğŸ‘¤';
                const color = tag.includes('mage') ? '#8b7dd8' : '#d88b7d';
                return `<div class="character-sprite" style="color: ${color}">${emoji}</div>`;
            }).join('');

            const showChoices = node.event?.type === 'CHOICE' && gameState.isTextComplete;
            const choicesHTML = showChoices ? `
        <div class="choice-container">
          ${node.event.payload.choices.map((c, i) =>
                `<button class="choice-button" onclick="selectChoice(${c.nextStoryID})">${c.label}</button>`
            ).join('')}
        </div>
      ` : '';

            app.innerHTML = `
        <div class="main-game-screen">
          <div class="background-layer ${bgClass}"></div>
          
          <header class="game-header">
            <button class="header-btn" onclick="returnToChapterGallery()">
              <span class="material-icons">arrow_back</span>
              <span class="label">æˆ»ã‚‹</span>
            </button>
            <div class="header-right">
              <button class="header-btn" onclick="console.log('Item box clicked')">
                <span class="material-icons">inventory_2</span>
              </button>
              <button class="header-btn" onclick="toggleMenuModal()">
                <span class="material-icons">menu</span>
                <span class="label">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
              </button>
            </div>
          </header>

          ${charaTags.length > 0 ? `<div class="character-layer">${charaHTML}</div>` : ''}
          <div class="message-window" onclick="handleMessageClick()">
            <div class="speaker-name">${node.speaker || 'ãƒŠãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³'}</div>
            <div class="message-text">
              ${gameState.displayText}
              ${gameState.isTextComplete ? '<span class="next-indicator">â–¼</span>' : ''}
            </div>
          </div>
          ${choicesHTML}
          ${renderMenuModal()}
        </div>
      `;

            if (node.text && gameState.fullText !== node.text) {
                console.log('renderMainGame: Starting typewriter for text:', node.text);
                startTypewriter(node.text);
            } else if (!node.text) {
                // ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆï¼ˆENDã‚¤ãƒ™ãƒ³ãƒˆãªã©ï¼‰ã¯å®Œäº†çŠ¶æ…‹ã«ã™ã‚‹
                gameState.isTextComplete = true;
                gameState.displayText = '';
            }
        }

        // ============================================
        // ãƒªã‚¶ãƒ«ãƒˆç”»é¢
        // ============================================

        function renderResultScreen(app) {
            const trustedReason = gameState.flags.trusted_reason || false;
            app.innerHTML = `
        <div class="result-screen">
          <div class="result-content">
            <h2 class="result-title">${trustedReason ? 'çœŸç†ã¸ã®é“' : 'ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°'}</h2>
            <p class="result-message">
              ${trustedReason
                    ? 'ç†ã®é­”æ³•ä½¿ã„ã¯ã€è«–ç†ã®åŠ›ã§è¬ã‚’è§£ã„ãŸã€‚'
                    : 'ç‰©èªã¯çµ‚ã‚ã‚Šã‚’è¿ãˆãŸã€‚'}
            </p>
            <button class="return-button" onclick="returnToChapterGallery()">ãƒãƒ£ãƒ—ã‚¿ãƒ¼é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      `;
        }

        // ============================================
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        // ============================================

        function findChapterById(chapterId) {
            for (let episode of episodesData.episodes) {
                for (let chapter of episode.chapters) {
                    if (chapter.id === chapterId) {
                        return { episode, chapter };
                    }
                }
            }
            return null;
        }

        function startTypewriter(text) {
            gameState.fullText = text;
            gameState.displayText = '';
            gameState.isTextComplete = false;

            if (typewriterInterval) clearInterval(typewriterInterval);

            let index = 0;
            typewriterInterval = setInterval(() => {
                if (index < text.length) {
                    gameState.displayText += text[index];
                    index++;
                    render();
                } else {
                    gameState.isTextComplete = true;
                    clearInterval(typewriterInterval);
                    render();
                }
            }, 50);
        }

        // ============================================
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        // ============================================

        function goToChapterGallery() {
            gameState.screen = 'CHAPTER_GALLERY';
            gameState.selectedChapter = 'ep1-ch1';
            gameState.isPanelOpen = true;
            render();
        }

        function togglePanel() {
            gameState.isPanelOpen = !gameState.isPanelOpen;
            render();
        }

        function selectChapter(chapterId) {
            gameState.selectedChapter = chapterId;
            render();
        }

        function startEvent(startStoryID) {
            console.log('startEvent called with ID:', startStoryID);
            gameState.screen = 'MAIN';
            gameState.currentStoryID = startStoryID;
            gameState.flags = {};
            render();
        }

        function handleMessageClick() {
            const node = scenarioData.scenario.find(n => n.storyID === gameState.currentStoryID);

            if (!gameState.isTextComplete) {
                if (typewriterInterval) clearInterval(typewriterInterval);
                gameState.displayText = gameState.fullText;
                gameState.isTextComplete = true;
                render();
            } else if (node.event?.type !== 'CHOICE') {
                nextLine(node);
            }
        }

        function nextLine(node) {
            if (node.event?.type === 'END') {
                gameState.flags = { ...gameState.flags, ...node.flags };
                gameState.screen = 'RESULT';
                render();
            } else if (node.event?.type === 'TAP_NEXT') {
                gameState.currentStoryID = node.event.payload.nextStoryID;
                render();
            } else {
                const currentIndex = scenarioData.scenario.findIndex(n => n.storyID === gameState.currentStoryID);
                const nextNode = scenarioData.scenario[currentIndex + 1];
                if (nextNode) {
                    gameState.currentStoryID = nextNode.storyID;
                    render();
                }
            }
        }

        function selectChoice(nextStoryID) {
            gameState.currentStoryID = nextStoryID;
            render();
        }

        function returnToChapterGallery() {
            gameState.screen = 'CHAPTER_GALLERY';
            if (typewriterInterval) clearInterval(typewriterInterval);
            render();
        }

        function renderMenuModal() {
            if (!gameState.isMenuOpen) return '';

            return `
        <div class="menu-modal-overlay" onclick="toggleMenuModal()">
          <div class="menu-modal-content" onclick="event.stopPropagation()">
            <h3 class="menu-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
            <button class="menu-item-btn" onclick="toggleMenuModal()">
              <span class="material-icons">close</span> é–‰ã˜ã‚‹
            </button>
            <button class="menu-item-btn" onclick="returnToTitle()">
              <span class="material-icons">home</span> ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹
            </button>
          </div>
        </div>
      `;
        }

        function toggleMenuModal() {
            gameState.isMenuOpen = !gameState.isMenuOpen;
            render();
        }

        function returnToTitle() {
            gameState.screen = 'TITLE';
            gameState.isMenuOpen = false;
            if (typewriterInterval) clearInterval(typewriterInterval);
            render();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        initGame();
    </script>
</body>

</html>